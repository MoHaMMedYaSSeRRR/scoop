<section>
  <div class="container m-auto m-3 p-5">
    <!-- Step 1: PDF Upload and Form Inputs -->
    <div *ngIf="step1" class="step1">
      <div
        class="pdfUpload d-flex justify-content-center align-items-center p-5"
      >
        <div class="logo text-center">
          <img
            src="../../../assets/image/pdf 2.png"
            alt="Upload PDF"
            (click)="triggerFileInput()"
            style="cursor: pointer"
          />
          <h6 class="mt-3">{{ fileName || "تحميل ملف PDF" }}</h6>
        </div>
      </div>

      <form class="my-3 text-end" [formGroup]="pdfForm">
        <input
          type="file"
          accept="application/pdf"
          #fileInput
          (change)="onFileSelected($event)"
          hidden
        />
        <label for="pageCount">عدد صفحات الامتحان</label>
        <input
          id="pageCount"
          type="number"
          class="form-control p-2 rounded-1 my-2"
          formControlName="pageCount"
        />
        <!-- <label for="quesCount">عدد الأسئلة</label>
        <input
          id="quesCount"
          type="number"
          class="form-control p-2 rounded-1 my-2"
          formControlName="questionCount"
        /> -->
        <button
        type="button"
        class="rounded-2 py-2 border-0 text-white px-5 d-block me-auto mt-3"
        (click)="onSubmit()"
        [disabled]="pdfForm.invalid || isLoading"
      >
        <span *ngIf="isLoading" class="fa fa-spinner fa-spin me-2"></span>
        <span *ngIf="!isLoading">التالي</span>
      </button>
      
      </form>
    </div>

    <!-- Step 2: PDF Display and Question Form -->
    <div
      *ngIf="step2"
      class="step2 justify-content-between overflow-hidden align-items-center"
    >
      <div class="row g-2">
        <div class="col-md-6 text-end">
          <div class="show p-0">
            <img
              *ngIf="pdfImages.length > 0"
              [src]="pdfImages[currentPage]"
              (mousedown)="onMouseDown($event)"
              (mousemove)="onMouseMove($event)"
              (mouseup)="onMouseUp()"
              (mouseleave)="onMouseUp()"
            />

            <!-- Render all finalized selection boxes -->
            <div
              *ngFor="let box of selectionBoxes"
              class="selection-box"
              [ngStyle]="{
                left: box.x + 'px',
                top: box.y + 'px',
                width: box.width + 'px',
                height: box.height + 'px'
              }"
            ></div>

            <!-- Render current selection box while dragging -->
            <div
              class="selection-box"
              *ngIf="isSelecting"
              [ngStyle]="{
                left: selectionBox.x + 'px',
                top: selectionBox.y + 'px',
                width: selectionBox.width + 'px',
                height: selectionBox.height + 'px'
              }"
            ></div>
          </div>
          <div
            class="arrows d-flex justify-content-between align-items-center w-50 m-auto mt-3 text-center"
          >
            <span
              role="button"
              (click)="goToPreviousPage()"
              [class.disabled]="currentPage === 0"
            >
              <i class="fa fa-arrow-left"></i>
            </span>
            <span>{{ currentPage + 1 }} / {{ userPageCount }}</span>
            <span
              role="button"
              (click)="goToNextPage()"
              [class.disabled]="currentPage === userPageCount - 1"
            >
              <i class="fa fa-arrow-right"></i>
            </span>
          </div>
        </div>

        <div class="col-md-5">
          <div class="content text-end ps-md-3 p-1">
            <h3 class="mb-2">
              برجاء ادخال البيانات التالية لكل صفحة في الامتحان
            </h3>
            <form
              class="my-2"
              [formGroup]="getCurrentQuestionFormGroup()"
              (ngSubmit)="onCurrentQuestionSubmit()"
            >
              <!-- Column Number -->
              <label for="colnumber">عدد الاجابات</label>
              <input
                type="number"
                class="form-control p-2 rounded-1 my-2"
                formControlName="colNumber"
                required
              />

              <!-- Fractioned Grades -->
              <label for="score">الدرجة</label>
              <input
                type="text"
                class="form-control p-2 rounded-1 my-2"
                formControlName="choices"
                required
              />

              <!-- Direction (افقي or راسي) -->
              <label for="direction" class="mt-3">اتجاه</label>
              <div class="row justify-content-end align-items-center mt-2">
                <div
                  class="col-3 d-flex justify-content-end align-items-center"
                >
                  <input
                    type="radio"
                    id="horizontal"
                    name="direction"
                    formControlName="direction"
                    value="horizontal"
                    class="mx-2 mt-1"
                    (click)="checkdirection('horizontal')"
                  />
                  <label (click)="checkdirection('horizontal')" for="horizontal"
                    >افقي</label
                  >
                </div>
                <div class="col-3">
                  <input
                    type="radio"
                    id="vertical"
                    name="direction"
                    formControlName="direction"
                    value="vertical"
                    class="mx-2 mt-1"
                    (click)="checkdirection('vertical')"
                  />
                  <label (click)="checkdirection('vertical')" for="vertical"
                    >راسي</label
                  >
                </div>
              </div>

              <!-- Marked by Teacher (Yes or No) -->
              <label for="marked" class="mt-3">يتم تصحيحه</label>
              <div class="row justify-content-end align-items-center mt-2">
                <div class="col-3">
                  <input
                    type="radio"
                    id="no"
                    name="marked"
                    formControlName="marked"
                    [value]="false"
                    class="mx-2"
                  />
                  <label for="no">لا</label>
                </div>
                <div class="col-3">
                  <input
                    type="radio"
                    id="yes"
                    name="marked"
                    formControlName="marked"
                    [value]="true"
                    class="mx-2"
                  />
                  <label for="yes">نعم</label>
                </div>
              </div>

              <!-- Graded by Teacher (Yes or No) -->
              <label for="gradedByTeacher" class="mt-3"
                >يصحح بواسطة المعلم</label
              >
              <div class="row justify-content-end align-items-center mt-2">
                <div class="col-3">
                  <!-- <input
                    type="radio"
                    id="teacher-no"
                    name="gradedByTeacher"
                    formControlName="gradedByTeacher"
                    [value]="false"
                    class="mx-2"
                  />
                  <label for="teacher-no">لا</label> -->
                </div>
                <div class="col-3">
                  <input
                    type="checkbox"
                    id="teacher-yes"
                    name="gradedByTeacher"
                    formControlName="gradedByTeacher"
                    [value]="true"
                    class="mx-2"
                  />
                  <label for="teacher-yes">نعم</label>
                </div>
              </div>

              <!-- Method (Right to Left or Left to Right based on Language) -->
              <label *ngIf="direction == 'horizontal'" for="method" class="mt-3"
                >طريقة الكتابة</label
              >
              <div
                *ngIf="direction == 'horizontal'"
                class="row justify-content-end align-items-center mt-2"
              >
                <div
                  class="col-4 d-flex justify-content-end align-items-center"
                >
                  <input
                    type="radio"
                    id="rtl"
                    name="method"
                    formControlName="method"
                    value="right-to-left"
                    class="mx-2 mt-1"
                  />
                  <label for="rtl">من اليمين لليسار</label>
                </div>
                <div class="col-4">
                  <input
                    type="radio"
                    id="ltr"
                    name="method"
                    formControlName="method"
                    value="left-to-right"
                    class="mx-2 mt-1"
                  />
                  <label for="ltr">من اليسار لليمين</label>
                </div>
              </div>
              <label *ngIf="direction == 'vertical'" for="method" class="mt-3"
                >طريقة الكتابة</label
              >
              <div
                *ngIf="direction == 'vertical'"
                class="row justify-content-end align-items-center mt-2"
              >
                <div
                  class="col-4 d-flex justify-content-end align-items-center"
                >
                  <input
                    type="radio"
                    id="btt"
                    name="method"
                    formControlName="method"
                    value="bottom-to-top"
                    class="mx-2 mt-1"
                  />
                  <label for="btt">من الاسفل للاعلي</label>
                </div>
                <div class="col-4">
                  <input
                    type="radio"
                    id="ttb"
                    name="method"
                    formControlName="method"
                    value="top-to-bottom"
                    class="mx-2 mt-1"
                  />
                  <label for="ttb">من الاعلي للاسفل</label>
                </div>
              </div>
            </form>
          </div>
        </div>

        <button
          type="button"
          class="sendBtn p-2 border-0 text-white d-block me-auto mt-3"
          (click)="onFinalSubmit()"
        >
          ارسال
        </button>
        <button
          type="button"
          class="sendBtn ms-1 p-2 border-0 text-white d-block me-auto mt-3"
          (click)="onCurrentQuestionSubmit()"
        >
          التالي
        </button>
      </div>
    </div>
  </div>
</section>
